---
title: "ProyectoTD2022"
author: "Grupo D"
date: "3/4/2022"
output:
  html_document:
    echo: yes
    number_sections: yes
    theme: lumen
    toc: yes
---

Cargamos las librerias necesarias.

```{r}
#Cargamos todas las librerias necesarias para trabajar.
packages=c("tidyverse", "knitr", "ggplot2", "datasets", "RColorBrewer", "dplyr", "readr", "tidyr","lubridate","gganimate","plotly","png","paletteer")
# use this function to check if each package is on the local machine
# if a package is installed, it will be loaded
# if any are not, the missing package(s) will be installed and loaded
package.check <- lapply(packages, FUN=function(x) {
  if (!require(x, character.only=TRUE)) {
    install.packages(x, dependencies=TRUE,repos='http://cran.rediris.es')
    library(x, character.only=TRUE)
  }
})
opts_chunk$set(echo=T, message = F, error = T, warning = T, comment = NA, fig.align = 'center', dpi = 200, tidy = F, cache.path = '.cache/', fig.path = './figura/')
# verify they are loaded
search()
```

Limpiamos el entorno de trabajo antes de comenzar a trabajar.

```{r}
rm(list = ls())
```

# Contactar con los compañeros de grupo

# Crear el repositorio ProyectoTD2022
El repositorio se encunetra en el siguinete enlace: https://github.com/Josepgirpla/ProyectoTD2022.git

# Descargar y almacenarlos los ficheros de datos
Los ficheros han sido almacenados en la carpeta ./data contenida en el proyecto

# Importación y fusión de los datos
Importamos los datos descargados en distintos dataframes.

```{r}

Cadiz_3 <- read_csv("data/Cadiz_3.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Cadiz_16 <- read_csv("data/Cadiz_16.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Carles_Cervera_34 <- read_csv("data/Carles_Cervera_34.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Carles_Cervera_Chaflan_Reina_Dona_Maria <- read_csv("data/Carles_Cervera_Chaflan_Reina_Dona_Maria.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Cuba_3 <- read_csv("data/Cuba_3.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Doctor_Serrano_21 <- read_csv("data/Doctor_Serrano_21.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

General_Prim_Chaflan_Donoso_Cortes <- read_csv("data/General_Prim_Chaflan_Donoso_Cortes.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Puerto_Rico_21 <- read_csv("data/Puerto_Rico_21.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Salvador_Abril_Chaflan_Maestro_Jose_Serrano <- read_csv("data/Salvador_Abril_Chaflan _Maestro_Jose_Serrano.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Sueca_2 <- read_csv("data/Sueca_2.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Sueca_32 <- read_csv("data/Sueca_32.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Sueca_61 <- read_csv("data/Sueca_61.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Sueca_Esq_Denia <- read_csv("data/Sueca_Esq_Denia.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Vivons_Chaflan_Cadiz <- read_csv("data/Vivons_Chaflan_Cadiz.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))
```


Manipulamos los datos para obtener un solo dataframe bien estructurado.

```{r}
#Añadimos una columna que contenga el nombre de la calle para poder identificarlas despues.
Cadiz_16 <- cbind(Cadiz_16, Nombre_calle = c("Cadiz_16"))

Cadiz_3 <- cbind(Cadiz_3, Nombre_calle = c("Cadiz_3"))

Carles_Cervera_34 <- cbind(Carles_Cervera_34, Nombre_calle = c("Carles_Cervera_34"))

Carles_Cervera_Chaflan_Reina_Dona_Maria <- cbind(Carles_Cervera_Chaflan_Reina_Dona_Maria,
                                                 Nombre_calle = c("Carles_Cervera_Chaflan_Reina_Dona_Maria"))

Cuba_3 <- cbind(Cuba_3, Nombre_calle = c("Cuba_3"))

Doctor_Serrano_21 <- cbind(Doctor_Serrano_21, Nombre_calle = c("Doctor_Serrano_21"))

General_Prim_Chaflan_Donoso_Cortes <- cbind(General_Prim_Chaflan_Donoso_Cortes,
                                            Nombre_calle = c("General_Prim_Chaflan_Donoso_Cortes"))

Puerto_Rico_21 <- cbind(Puerto_Rico_21, Nombre_calle = c("Puerto_Rico_21"))

Salvador_Abril_Chaflan_Maestro_Jose_Serrano <-cbind(Salvador_Abril_Chaflan_Maestro_Jose_Serrano,
                                                    Nombre_calle = c("Salvador_Abril_Chaflan_Maestro_Jose_Serrano"))

Sueca_2 <- cbind(Sueca_2, Nombre_calle = c("Sueca_2"))

Sueca_32 <- cbind(Sueca_32, Nombre_calle = c("Sueca_32"))

Sueca_61 <- cbind(Sueca_61, Nombre_calle = c("Sueca_61"))

Sueca_Esq_Denia <- cbind(Sueca_Esq_Denia, Nombre_calle = c("Sueca_Esq_Denia"))

Vivons_Chaflan_Cadiz <- cbind(Vivons_Chaflan_Cadiz, Nombre_calle = c("Vivons_Chaflan_Cadiz"))



#Unimos todos los df en uno solo.
df <- rbind(Cadiz_16, Cadiz_3, Carles_Cervera_34, Carles_Cervera_Chaflan_Reina_Dona_Maria,
            Cuba_3, Doctor_Serrano_21, General_Prim_Chaflan_Donoso_Cortes, Puerto_Rico_21,
            Salvador_Abril_Chaflan_Maestro_Jose_Serrano, Sueca_2, Sueca_32, Sueca_61,
            Sueca_Esq_Denia, Vivons_Chaflan_Cadiz)

#Modificamos los nombres de las columnas por unos más representativos.
colnames(df) <- c("Id", "Fecha_registro", "Servicio_sensor", "Tipo_entidad_sensor", "Id_sensor",
                  "Nivel_sonoro_continuo_equivalente", "Nivel_sonoro_dia",
                  "Nivel_sonoro_dia_tarde_noche", "Nivel_sonoro_tarde",
                  "Nivel_sonoro_noche", "Dia_medicion", "Nombre_calle")

head(df)
summary(df)

#Como vemos hay +inf en el nivel sonoro de día
nivel_sonoro_dia = df[,7]
nivel_sonoro_dia[is.infinite(nivel_sonoro_dia)] <- NA
nivel_sonoro_dia_media = mean(nivel_sonoro_dia, na.rm = T)

df[which(is.infinite(unlist(df[7]))),7] <- nivel_sonoro_dia_media

#Como vemos hay +inf en el nivel sonoro de tarde
nivel_sonoro_tarde = df[,9]
nivel_sonoro_tarde[is.infinite(nivel_sonoro_tarde)] <- NA
nivel_sonoro_tarde_media = mean(nivel_sonoro_tarde, na.rm = T)

df[is.na(nivel_sonoro_tarde),9] <- nivel_sonoro_tarde_media

summary(df)
```

## Preguntas a reponder en el proyecto

  1. ¿Cuáles son las calles mas ruidosas en cada momento del día?¿Existen diferencias entre los fines de semana y el resto de días? 
  2. ¿Hay alguna calle q exceda  en algún momento  los estándares impuestos en la ley estatal de ruido?
  3. ¿Podemos determinar horarios o patrones de ruido en los datos recogidos por los sensores?
  4. ¿Existe alguna relación entre los días festivos en la ciudad y un cambio en la tendencia de los datos recogidos?
  5. ¿Cuáles son las horas del día con mas ruido en cada calle? Y en la ciudad en general?
  6. ¿Podemos tratar de deducir el provocante de un ruido anormal a partir de la posición de un sensor?
  7. Con los datos proporcionados, ¿Es posible realizar un mapa de ruido?


# Acondicionamiento de los datos para que se correspondan con un tidy dataset.

Vamos a hacerlo tidy

```{r}
df <- df %>% gather(key= "tipo_medida", value = "valor", 6:10)
head(df)
```

# Desarrollo del proyecto
Vamos a comenzar con el estudio de los datos sin hacer disticiones en las calles, para ello crearemos un nuevo df con la media por dias de cada uno de las distintas medidas

```{r}
total = df %>% group_by(tipo_medida, Dia_medicion) %>% summarise(valor = mean(valor)) %>% select(Dia_medicion,tipo_medida,valor)
```

Vamos a ver como evoluciona la contaminación sonora según el día de la semana.

```{r}
dias = c("lunes","martes","miércoles","jueves","viernes","sábado","domingo")
total %>%
  #Se añade la columna con el día de la semana
  mutate(dia = weekdays(Dia_medicion)) %>%
  #Se hace la columna día un factor
  mutate(dia = factor(weekdays(Dia_medicion), ordered = T,levels = dias)) %>%
  #Se elimina la columna dia medición
  select(-Dia_medicion) %>%
  #Se agrupa por dia y el tipo de medida para hacer una columna de valor una media
  group_by(dia, tipo_medida) %>%
  mutate(valor = mean(valor)) %>%
  #Se eliminan los repetidos
  unique() %>%
  #Se hace una columna con el dia de la semana en número
  mutate(dia_num = grep(dia,dias)) %>%
  #Se hace el gráfico en función del tipo de medida
  ggplot(aes(x = dia, y = valor, color = tipo_medida, group = tipo_medida)) + 
  geom_line() +
  labs(title = "Nivel sonoro en función del día de la semana", subtitle = "Esta es la evolución de cada uno de las distintas medidas \ndel nivel sonoro en función del día de la semana", x = "Día de la semana", y = "Nivel sonoro", fill = "Tipo de medida") +
  transition_reveal(dia_num)
```

Vamos a ver como evoluciona a lo largo de los meses. Se utilizará solo el nivel sonoro continuo equivalente

```{r}
meses = c("enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiempre","octubre","noviembre","diciembre")
grafico = total %>%
  #Se añade la columna con el día de la semana
  mutate(mes_num = month(Dia_medicion)) %>%
  #Se utiliza solo el nivel sonoro equivalente
  filter(tipo_medida == "Nivel_sonoro_continuo_equivalente") %>%
  #Se elimina la columna dia medición
  select(-Dia_medicion) %>%
  #Se agrupa por dia y el tipo de medida para hacer una columna de valor una media
  group_by(mes_num, tipo_medida) %>%
  mutate(valor = mean(valor)) %>%
  #Se eliminan los repetidos
  unique() %>%
  #Se hace una columna con el mes
  mutate(mes = meses[mes_num]) %>%
  mutate(mes = factor(mes,ordered = T, levels = meses)) %>%
  #Se hace el gráfico en función del tipo del mes
  ggplot(aes(x = mes, y = valor, fill = mes)) + 
  geom_bar(stat="identity") + 
  theme(legend.position="none",axis.text.x = element_text(angle = 45,hjust = 1, vjust = 1)) + 
  coord_cartesian(ylim = c(55,65))
ggplotly(grafico, height = 350, width=600)
```

Ahora vamos a continuar viendo la evolución del ruido por dias segun las calles

```{r}
coordx = c("Cadiz_3" = 3, "Cadiz_16" = 3, "Carles_Cervera_34" = 3.2, "Carles_Cervera_Chaflan_Reina_Dona_Maria" = 3,"Cuba_3" = 0.86, "Doctor_Serrano_21" = 3.1, "General_Prim_Chaflan_Donoso_Cortes" = 6, "Puerto_Rico_21" = 1.5, "Salvador_Abril_Chaflan_Maestro_Jose_Serrano" = 6, "Sueca_2" = 1.95, "Sueca_32" = 1.95, "Sueca_61" = 1.95, "Sueca_Esq_Denia" = 1.95, "Vivons_Chaflan_Cadiz" = 3)
coordy = c("Cadiz_3" = 4.25, "Cadiz_16" = 4.1, "Carles_Cervera_34" = 2, "Carles_Cervera_Chaflan_Reina_Dona_Maria" = 1.85,"Cuba_3" = 4.25, "Doctor_Serrano_21" = 3.35, "General_Prim_Chaflan_Donoso_Cortes" = 2.2, "Puerto_Rico_21" = 2.93, "Salvador_Abril_Chaflan_Maestro_Jose_Serrano" = 3.1, "Sueca_2" = 4.5, "Sueca_32" = 2.9, "Sueca_61" = 1.6, "Sueca_Esq_Denia" = 4, "Vivons_Chaflan_Cadiz" = 1)

ruzafa = readPNG("./data/ruzafa.png")

df %>% 
  #Se añade la columna con el día de la semana
  mutate(mes_num = month(Dia_medicion)) %>%
  #Se utiliza solo el nivel sonoro equivalente
  filter(tipo_medida == "Nivel_sonoro_continuo_equivalente") %>%
  #Se elimina la columna dia medición
  select(-c(Dia_medicion,Fecha_registro,Id)) %>%
  #Se agrupa por dia y el tipo de medida para hacer una columna de valor una media
  group_by(mes_num, tipo_medida, Nombre_calle) %>%
  mutate(valor = mean(valor)) %>%
  mutate(invalor = 1/mean(valor)) %>%
  #Se eliminan los repetidos
  unique() %>%
  #Se hace una columna con el mes
  mutate(mes = meses[mes_num]) %>%
  mutate(mes = factor(mes,ordered = T, levels = meses)) %>%
  #Se utiliza solo el nivel sonoro equivalente
  filter(tipo_medida == "Nivel_sonoro_continuo_equivalente") %>%
  #Se hace el gráfico
  ggplot(aes(x = coordx[Nombre_calle], y = coordy[Nombre_calle])) +
  background_image(ruzafa) +
  geom_point(alpha=0.5, aes(col = invalor, size = valor)) +
  xlim(c(0,6)) + 
  ylim(c(0,4.5)) + 
  theme(legend.position = "None") +
  transition_manual(frames = mes) +
  labs(title = "Distribución de sonidos en función del mes y el lugar", subtitle = "{current_frame}")
```

