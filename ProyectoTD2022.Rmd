---
title: "ProyectoTD2022"
author: "Grupo D"
date: "3/4/2022"
output:
  html_document:
    echo: yes
    number_sections: yes
    theme: lumen
    toc: yes
---

```{r echo = F, message = F, warning = F}
library(knitr)
opts_chunk$set(echo=T, message = F, error = T, warning = T, comment = NA, fig.align = 'center', dpi = 200, tidy = F, cache.path = '.cache/', fig.path = './figura/')

packages = c("tidyverse")
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})
```

Limpiamos el entorno de trabajo antes de comenzar a trabajar.

```{r}
rm(list = ls())
```

Cargamos las librerias necesarias.

```{r}
#Cargamos todas las librerias necesarias para trabajar.
packages=c("tidyverse", "knitr", "ggplot2", "datasets", "RColorBrewer", "dplyr", "readr", "tidyr")
# use this function to check if each package is on the local machine
# if a package is installed, it will be loaded
# if any are not, the missing package(s) will be installed and loaded
package.check <- lapply(packages, FUN=function(x) {
  if (!require(x, character.only=TRUE)) {
    install.packages(x, dependencies=TRUE,repos='http://cran.rediris.es')
    library(x, character.only=TRUE)
  }
})
# verify they are loaded
search()
```
# Contactar con los compañeros de grupo

# Crear el repositorio ProyectoTD2022
El repositorio se encunetra en el siguinete enlace: https://github.com/Josepgirpla/ProyectoTD2022.git

# Descargar y almacenarlos los ficheros de datos
Los ficheros han sido almacenados en la carpeta ./data contenida en el proyecto

# Importación y fusión de los datos
Importamos los datos descargados en distintos dataframes.

```{r}

Cadiz_3 <- read_csv("data/Cadiz_3.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Cadiz_16 <- read_csv("data/Cadiz_16.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Carles_Cervera_34 <- read_csv("data/Carles_Cervera_34.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Carles_Cervera_Chaflan_Reina_Dona_Maria <- read_csv("data/Carles_Cervera_Chaflan_Reina_Dona_Maria.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Cuba_3 <- read_csv("data/Cuba_3.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Doctor_Serrano_21 <- read_csv("data/Doctor_Serrano_21.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

General_Prim_Chaflan_Donoso_Cortes <- read_csv("data/General_Prim_Chaflan_Donoso_Cortes.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Puerto_Rico_21 <- read_csv("data/Puerto_Rico_21.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Salvador_Abril_Chaflan_Maestro_Jose_Serrano <- read_csv("data/Salvador_Abril_Chaflan _Maestro_Jose_Serrano.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Sueca_2 <- read_csv("data/Sueca_2.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Sueca_32 <- read_csv("data/Sueca_32.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Sueca_61 <- read_csv("data/Sueca_61.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Sueca_Esq_Denia <- read_csv("data/Sueca_Esq_Denia.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Vivons_Chaflan_Cadiz <- read_csv("data/Vivons_Chaflan_Cadiz.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))
```


Manipulamos los datos para obtener un solo dataframe bien estructurado.

```{r}
#Añadimos una columna que contenga el nombre de la calle para poder identificarlas despues.
Cadiz_16 <- cbind(Cadiz_16, Nombre_calle = c("Cadiz_16"))

Cadiz_3 <- cbind(Cadiz_3, Nombre_calle = c("Cadiz_3"))

Carles_Cervera_34 <- cbind(Carles_Cervera_34, Nombre_calle = c("Carles_Cervera_34"))

Carles_Cervera_Chaflan_Reina_Dona_Maria <- cbind(Carles_Cervera_Chaflan_Reina_Dona_Maria,
                                                 Nombre_calle = c("Carles_Cervera_Chaflan_Reina_Dona_Maria"))

Cuba_3 <- cbind(Cuba_3, Nombre_calle = c("Cuba_3"))

Doctor_Serrano_21 <- cbind(Doctor_Serrano_21, Nombre_calle = c("Doctor_Serrano_21"))

General_Prim_Chaflan_Donoso_Cortes <- cbind(General_Prim_Chaflan_Donoso_Cortes,
                                            Nombre_calle = c("General_Prim_Chaflan_Donoso_Cortes"))

Puerto_Rico_21 <- cbind(Puerto_Rico_21, Nombre_calle = c("Puerto_Rico_21"))

Salvador_Abril_Chaflan_Maestro_Jose_Serrano <-cbind(Salvador_Abril_Chaflan_Maestro_Jose_Serrano,
                                                    Nombre_calle = c("Salvador_Abril_Chaflan_Maestro_Jose_Serrano"))

Sueca_2 <- cbind(Sueca_2, Nombre_calle = c("Sueca_2"))

Sueca_32 <- cbind(Sueca_32, Nombre_calle = c("Sueca_32"))

Sueca_61 <- cbind(Sueca_61, Nombre_calle = c("Sueca_61"))

Sueca_Esq_Denia <- cbind(Sueca_Esq_Denia, Nombre_calle = c("Sueca_Esq_Denia"))

Vivons_Chaflan_Cadiz <- cbind(Vivons_Chaflan_Cadiz, Nombre_calle = c("Vivons_Chaflan_Cadiz"))



#Unimos todos los df en uno solo.
df <- rbind(Cadiz_16, Cadiz_3, Carles_Cervera_34, Carles_Cervera_Chaflan_Reina_Dona_Maria,
            Cuba_3, Doctor_Serrano_21, General_Prim_Chaflan_Donoso_Cortes, Puerto_Rico_21,
            Salvador_Abril_Chaflan_Maestro_Jose_Serrano, Sueca_2, Sueca_32, Sueca_61,
            Sueca_Esq_Denia, Vivons_Chaflan_Cadiz)

#Modificamos los nombres de las columnas por unos más representativos.
colnames(df) <- c("Id", "Fecha_registro", "Servicio_sensor", "Tipo_entidad_sensor", "Id_sensor",
                  "Nivel_sonoro_continuo_equivalente", "Nivel_sonoro_dia",
                  "Nivel_sonoro_dia_tarde_noche", "Nivel_sonoro_tarde",
                  "Nivel_sonoro_noche", "Dia_medicion", "Nombre_calle")

head(df)
summary(df)

#Como vemos hay +inf en el nivel sonoro de día
nivel_sonoro_dia = df[,7]
nivel_sonoro_dia[is.infinite(nivel_sonoro_dia)] <- NA
nivel_sonoro_dia_media = mean(nivel_sonoro_dia, na.rm = T)

df[which(is.infinite(unlist(df[7]))),7] <- nivel_sonoro_dia_media

#Como vemos hay +inf en el nivel sonoro de tarde
nivel_sonoro_tarde = df[,9]
nivel_sonoro_tarde[is.infinite(nivel_sonoro_tarde)] <- NA
nivel_sonoro_tarde_media = mean(nivel_sonoro_tarde, na.rm = T)

df[which(is.infinite(unlist(df[9]))),9] <- nivel_sonoro_tarde_media

summary(df)
```

## Preguntas a reponder en el proyecto

  1. ¿Cuáles son las calles mas ruidosas en cada momento del día?¿Existen diferencias entre los fines de semana y el resto de días? 
  2. ¿Hay alguna calle q exceda  en algún momento  los estándares impuestos en la ley estatal de ruido?
  3. ¿Podemos determinar horarios o patrones de ruido en los datos recogidos por los sensores?
  4. ¿Existe alguna relación entre los días festivos en la ciudad y un cambio en la tendencia de los datos recogidos?
  5. ¿Cuáles son las horas del día con mas ruido en cada calle? Y en la ciudad en general?
  6. ¿Podemos tratar de deducir el provocante de un ruido anormal a partir de la posición de un sensor?
  7. Con los datos proporcionados, ¿Es posible realizar un mapa de ruido?


# Acondicionamiento de los datos para que se correspondan con un tidy dataset.

Vamos a hacerlo tidy

```{r}
df <- df %>% pivot_longer(6:10,names_to = "tipo_medicion", values_to = "nivel")
head(df)
```

# Desarrollo del proyecto