---
title: "ProyectoTD2022"
author: "Roberto Arnaiz Asensio, Pedro De Luna Huerta, Josep Antoni Girbés Plaza, Lidia Moreno Marín"
date: "3/4/2022"
output:
  html_document:
    echo: yes
    number_sections: yes
    theme: lumen
    toc: yes
---

Cargamos las librerias necesarias.

```{r}
#Cargamos todas las librerias necesarias para trabajar.
packages=c("tidyverse", "knitr", "ggplot2", "datasets", "RColorBrewer", "dplyr", "readr", "tidyr","lubridate","gganimate","plotly","png","ggpubr","colorspace","magrittr","car","GGally")

# use this function to check if each package is on the local machine
# if a package is installed, it will be loaded
# if any are not, the missing package(s) will be installed and loaded
package.check <- lapply(packages, FUN=function(x) {
  if (!require(x, character.only=TRUE)) {
    install.packages(x, dependencies=TRUE,repos='http://cran.rediris.es')
    library(x, character.only=TRUE)
  }
})
opts_chunk$set(echo=T, message = F, error = T, warning = T, comment = NA, fig.align = 'center', dpi = 200, tidy = F, cache.path = '.cache/', fig.path = './figura/')
# verify they are loaded
search()
```

Limpiamos el entorno de trabajo antes de comenzar a trabajar.

```{r}
rm(list = ls())
```

# Contactar con los compañeros de grupo

# Crear el repositorio ProyectoTD2022
El repositorio se encunetra en el siguinete enlace: https://github.com/Josepgirpla/ProyectoTD2022.git

# Descargar y almacenarlos los ficheros de datos
Los ficheros han sido almacenados en la carpeta ./data contenida en el proyecto

# Importación y fusión de los datos
Importamos los datos descargados en distintos dataframes.

```{r}

Cadiz_3 <- read_csv("data/Cadiz_3.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Cadiz_16 <- read_csv("data/Cadiz_16.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Carles_Cervera_34 <- read_csv("data/Carles_Cervera_34.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Carles_Cervera_Chaflan_Reina_Dona_Maria <- read_csv("data/Carles_Cervera_Chaflan_Reina_Dona_Maria.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Cuba_3 <- read_csv("data/Cuba_3.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Doctor_Serrano_21 <- read_csv("data/Doctor_Serrano_21.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

General_Prim_Chaflan_Donoso_Cortes <- read_csv("data/General_Prim_Chaflan_Donoso_Cortes.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Puerto_Rico_21 <- read_csv("data/Puerto_Rico_21.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Salvador_Abril_Chaflan_Maestro_Jose_Serrano <- read_csv("data/Salvador_Abril_Chaflan _Maestro_Jose_Serrano.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Sueca_2 <- read_csv("data/Sueca_2.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Sueca_32 <- read_csv("data/Sueca_32.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Sueca_61 <- read_csv("data/Sueca_61.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Sueca_Esq_Denia <- read_csv("data/Sueca_Esq_Denia.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))

Vivons_Chaflan_Cadiz <- read_csv("data/Vivons_Chaflan_Cadiz.csv",
                    col_types = cols(dateObserved = col_date(format = "%Y-%m-%d")))
```


Manipulamos los datos para obtener un solo dataframe bien estructurado.

```{r}
#Añadimos una columna que contenga el nombre de la calle para poder identificarlas despues.
Cadiz_16 <- cbind(Cadiz_16, Nombre_calle = c("Cadiz_16"))

Cadiz_3 <- cbind(Cadiz_3, Nombre_calle = c("Cadiz_3"))

Carles_Cervera_34 <- cbind(Carles_Cervera_34, Nombre_calle = c("Carles_Cervera_34"))

Carles_Cervera_Chaflan_Reina_Dona_Maria <- cbind(Carles_Cervera_Chaflan_Reina_Dona_Maria,
                                                 Nombre_calle = c("Carles_Cervera_Chaflan_Reina_Dona_Maria"))

Cuba_3 <- cbind(Cuba_3, Nombre_calle = c("Cuba_3"))

Doctor_Serrano_21 <- cbind(Doctor_Serrano_21, Nombre_calle = c("Doctor_Serrano_21"))

General_Prim_Chaflan_Donoso_Cortes <- cbind(General_Prim_Chaflan_Donoso_Cortes,
                                            Nombre_calle = c("General_Prim_Chaflan_Donoso_Cortes"))

Puerto_Rico_21 <- cbind(Puerto_Rico_21, Nombre_calle = c("Puerto_Rico_21"))

Salvador_Abril_Chaflan_Maestro_Jose_Serrano <-cbind(Salvador_Abril_Chaflan_Maestro_Jose_Serrano,
                                                    Nombre_calle = c("Salvador_Abril_Chaflan_Maestro_Jose_Serrano"))

Sueca_2 <- cbind(Sueca_2, Nombre_calle = c("Sueca_2"))

Sueca_32 <- cbind(Sueca_32, Nombre_calle = c("Sueca_32"))

Sueca_61 <- cbind(Sueca_61, Nombre_calle = c("Sueca_61"))

Sueca_Esq_Denia <- cbind(Sueca_Esq_Denia, Nombre_calle = c("Sueca_Esq_Denia"))

Vivons_Chaflan_Cadiz <- cbind(Vivons_Chaflan_Cadiz, Nombre_calle = c("Vivons_Chaflan_Cadiz"))



#Unimos todos los df en uno solo.
df <- rbind(Cadiz_16, Cadiz_3, Carles_Cervera_34, Carles_Cervera_Chaflan_Reina_Dona_Maria,
            Cuba_3, Doctor_Serrano_21, General_Prim_Chaflan_Donoso_Cortes, Puerto_Rico_21,
            Salvador_Abril_Chaflan_Maestro_Jose_Serrano, Sueca_2, Sueca_32, Sueca_61,
            Sueca_Esq_Denia, Vivons_Chaflan_Cadiz)

#Modificamos los nombres de las columnas por unos más representativos.
colnames(df) <- c("Id", "Fecha_registro", "Servicio_sensor", "Tipo_entidad_sensor", "Id_sensor",
                  "Nivel_sonoro_continuo_equivalente", "Nivel_sonoro_dia",
                  "Nivel_sonoro_dia_tarde_noche", "Nivel_sonoro_tarde",
                  "Nivel_sonoro_noche", "Dia_medicion", "Nombre_calle")

head(df)
summary(df)

```

Para terminar con este apartado vamos a realizar un análisis de los valores especiales o inconsistencias que puedan aparecer en nuestro dataframe.

```{r}
#Primero vamos a determinar si hay o no datos especiales.

for (n in as.factor(colnames(df))){
  tabla_inconsist <- df %>% count(is.finite(n))
  
  if (tabla_inconsist[1,2] < nrow(df)){
    print(n)
    print(tabla_inconsist[1,2])
    }
}

#Realizamos una detección para cada columna con posibles valores especiales y los sustituimos por la media de todos los de su misma variable.

#Nivel_sonoro_continuo_equivalente
Nivel_sonoro_continuo_equivalente = df[,6]
Nivel_sonoro_continuo_equivalente[!is.finite(Nivel_sonoro_continuo_equivalente)] <- NA
Nivel_sonoro_continuo_equivalente_media = mean(Nivel_sonoro_continuo_equivalente, na.rm = T)

df[which(!is.finite(unlist(df[6]))),6] <- Nivel_sonoro_continuo_equivalente_media

#Nivel_sonoro_dia
nivel_sonoro_dia = df[,7]
nivel_sonoro_dia[!is.finite(nivel_sonoro_dia)] <- NA
nivel_sonoro_dia_media = mean(nivel_sonoro_dia, na.rm = T)

df[which(!is.finite(unlist(df[7]))),7] <- nivel_sonoro_dia_media

#Nivel_sonoro_dia_tarde_noche
 Nivel_sonoro_dia_tarde_noche = df[,8]
 Nivel_sonoro_dia_tarde_noche[!is.finite( Nivel_sonoro_dia_tarde_noche)] <- NA
 Nivel_sonoro_dia_tarde_noche_media = mean( Nivel_sonoro_dia_tarde_noche, na.rm = T)

df[which(!is.finite(unlist(df[8]))),8] <-  Nivel_sonoro_dia_tarde_noche_media

#Nivel_sonoro_tarde
nivel_sonoro_tarde = df[,9]
nivel_sonoro_tarde[!is.finite(nivel_sonoro_tarde)] <- NA
nivel_sonoro_tarde_media = mean(nivel_sonoro_tarde, na.rm = T)

df[!is.finite(nivel_sonoro_tarde),9] <- nivel_sonoro_tarde_media

#Nivel_sonoro_tarde
Nivel_sonoro_noche = df[,10]
Nivel_sonoro_noche[!is.finite(Nivel_sonoro_noche)] <- NA
Nivel_sonoro_noche_media = mean(Nivel_sonoro_noche, na.rm = T)

df[!is.finite(Nivel_sonoro_noche),10] <- Nivel_sonoro_noche_media


#Volvemos a aplicar el bucle anterior para comprovar que ya no hay datos especiales.
for (n in as.factor(colnames(df))){
  tabla_inconsist <- df %>% count(is.finite(n))
  
  if (tabla_inconsist[1,2] < nrow(df)){
    print(n)
    print(tabla_inconsist[1,2])
    }
}

head(df)
```

## Preguntas a reponder en el proyecto

  1. ¿Cuáles son las calles mas ruidosas en cada momento del día?¿Existen diferencias entre los fines de semana y el resto de días?
  
  *Respuesta*
  
  Si nos centramos en las diferencias que existen en los niveles de contaminación acústica entre los fines de semana y el resto de la semana nos damos cuenta rapidamente de que desde los jueves por la tarde hasta los domingos de madrugada los niveles sonoros aumentan considerablemente superando con creces los límites legales que la Ley 7/2002, de 3 de diciembre, de protección contra la contaminación acústica establece como límites legales.
  
  2. ¿En algún momento el barrio de Ruzafa supera los estándares impuestos en la ley estatal de ruido?
  
  *Respuesta*
  
  Si, como más adelante explicaremos con los gráficos realizados durante el estudio de contaminación acustica en el barrio de Ruzafa y con los datos observados y comparando los niveles sonoros con los establecidos en la ley de contaminación acústica podemos afirmar que el barrio de Ruzafa esta por encima de los estándares en todas las horas del día durante todos los días de la semana. 
  
  3. ¿Podemos determinar horarios o patrones de ruido en los datos recogidos por los sensores?
  4. ¿Existe alguna relación entre los días festivos en la ciudad y un cambio en la tendencia de los datos recogidos?
  
  *Respuesta*
  
  Nuestra hipotesis inicial es que si existe una relación entre las festividades más importantes del barrio de Ruzafa así como las de la ciudad de Valencia. Hemos dibujado un gráfico donde agrupamos en el nivel sonoro por meses del año ya que hacer un estudio solo por días no era demásiado representativo.
  
  Una vez con el gráfico hecho y tras analizar en más profundidad las festividades que cumplen los requisitos en cuanto a duración y calibre (gente a la que atrae la festividad, nivel de actividad en las calles debido a la fiesta en cuestiónb) de la festividad concluimos que vemos cambios significativos en el mes de marzo, cosa que esperabamos ya que en este mes se celebra una de las fiestas más importantes de Valencia sino la más importante. Notamos un amuento en los niveles registrayos ya que en estas fiestas las actividades principales són hacer mascletaes, fuegos artificiales y de más actividades que generen un alto nivel sonoro. 
  
  En contra partida nos dimos cuenta que este patrón no se seguia para el resto de festividades consideradas como la semana santa, donde se realizan procesiones y demás actividades al aire libre y podían causar un aumento en los niveles registrados por los sonómetros. Tampoco detectamos aumentos para las fiestas de navidad, ni para el periodo vacacional de verano de los calendarios lectivos. La explicación que encontramos para esto ha sido que tanto en verano como navidades o semana santa mucha gente aprovecha para volver a sus casas y estar con la familia. Y como el barrio de ruzafa esta frcuentado por gente joven o estudiantes durante estos periodos no residen en el barrio y por eso no vemos un aumento considerable en los niveles de ruido.
  
  Por tanto piodemos concluir que nuestra hipotesis inicial no era correcta.
  
  5. ¿Podemos tratar de deducir el provocante de un ruido anormal a partir de la posición de un sensor?
  6. Con los datos proporcionados, ¿Es posible realizar un mapa de ruido?


# Acondicionamiento de los datos para que se correspondan con un tidy dataset.

Vamos a hacerlo tidy
```{r}
df <- df %>% gather(key= "tipo_medida", value = "valor", 6:10)
head(df)
```

# Analisis univariante

```{r}
lapply(df[3:4],unique)
```

Como podemos ver hay muchos datos que son igual todo el rato, por lo que nos vamos a quedar con los datos que no se repiten y que nos proporcionan información. El Id, el Id del sensor y la fecha del registro no nos proporciona información, ya que lo que nos interesa en vez de estos camos es la fecha de la medición y el nombre de la calle

```{r}
df %<>% select(Dia_medicion,tipo_medida,valor,Nombre_calle)
```

Vamos a ver como quedan los datos

```{r}
head(df) %>% kable()
summary(df) %>% kable()
```

Como vemos los datos se recogen desde septiembre del 2020 hasta abril del 2022.
También se ve que el valor va desde 40 hasta casi 100, pero vemos que el rango interquartil es muy pequeño

Vamos a ver si el valor se ajusta a una distribución normal:
  
```{r}
qqPlot(df$valor)
```

Como vemos no se ajusta a una distribución normal.

# Analisis bivariante

Vamos a ver como de correlacionadas están las varibles.
```{r}
df %>% select(Dia_medicion,valor) %>% ggpairs()
```

A parte de ver que la correlación es muy baja (0.23) Se ve que no hay datos registrados en julio.

Vamos a ver como de relacionadas están las variables de el valor y el nombre de la calle

```{r}
chisq.test(x = df$valor, y = df$Nombre_calle,correct = F)
```

Podemos ver que p es muy pequeño, por ello vemos que si que están relacionados.

Seguro que el nivel sonoro está relacionado con el tipo de medicion, por eso en vez de ver la relación que hay entre ellas vamos a ver como de relacionado están los valores entre sí en función del tipo de medición:
  
```{r}
nombres = unique(df$tipo_medida)
df %>% spread(key = tipo_medida, value = valor) %>% select(nombres) %>% ggpairs()
```

Como podemos ver la mayor correlación está entre el nivel sonoro del día y el nivel continuo equivalente

```{r}
df %>% spread(key = tipo_medida, value = valor) %>% select(nombres) %>% ggcorr()
```

Como vemos en esta forma más gráfica no es mucha la diferencia entre las correlaciones, y también se ve que son correlaciones muy elevadas

# Desarrollo del proyecto
Vamos a comenzar con el estudio de los datos sin hacer disticiones en las calles, para ello crearemos un nuevo df con la media por dias de cada uno de las distintas medidas

```{r}
total = df %>% group_by(tipo_medida, Dia_medicion) %>% summarise(valor = mean(valor)) %>% select(Dia_medicion,tipo_medida,valor)
```

Vamos a ver como evoluciona la contaminación sonora según el día de la semana.

```{r}
dias = c("lunes","martes","miércoles","jueves","viernes","sábado","domingo")
total %>%
  #Se añade la columna con el día de la semana
  mutate(dia = weekdays(Dia_medicion)) %>%
  #Se hace la columna día un factor
  mutate(dia = factor(weekdays(Dia_medicion), ordered = T,levels = dias)) %>%
  #Se elimina la columna dia medición
  select(-Dia_medicion) %>%
  #Se agrupa por dia y el tipo de medida para hacer una columna de valor una media
  group_by(dia, tipo_medida) %>%
  mutate(valor = mean(valor)) %>%
  #Se eliminan los repetidos
  unique() %>%
  #Se hace una columna con el dia de la semana en número
  mutate(dia_num = grep(dia,dias)) %>%
  #Se hace el gráfico en función del tipo de medida
  ggplot(aes(x = dia, y = valor, color = tipo_medida, group = tipo_medida)) + 
  geom_line() +
  labs(title = "Nivel sonoro en función del día de la semana", subtitle = "Esta es la evolución de cada uno de las distintas medidas \ndel nivel sonoro en función del día de la semana", x = "Día de la semana", y = "Nivel sonoro", fill = "Tipo de medida") +
  transition_reveal(dia_num)
```
*Explicación y comentarios*
A simple vista podemos observar como a lo largo de los días de la semana los niveles de ruido tienen un comportamiento muy similar, todos siguen un patrón, donde decaen el martes pero a partir de ahí van en aumento hasta el domingo, sobre todo desde los jueves por la tarde hasta los sábados noche. 

Esto nos indica que a medida que avanza la semana, el barrio de ruzafa se vuelve más ruidoso. Si nos damos cuenta esto coincide con los días en los que es más "típico" salir de fiesta y por tanto vemos como evolucionan aumentando el sonido a medida que llegan estos días dado que ruzafa es un barrio repleto de bares, terrazas y lugares de ocio. Sin hacer ningún tipo de estudio en el tipo de personas que frecuentan el barrio de Ruzafa hemos concluido que muy posiblemente se trate de personas jovenes, esta conclusión la extraemos al observar que los niveles de ruido aumentan considerablemente cuando se acercan los fines de semana momento que se corresponde con una mayor actividad de los jòvenes y del ocio nocturno donde las principales actividades del sector se desempeñan habitualmente de jueves a sábado.

Ahora vamos a darle un enfoque diferente, veamos si el barrio de Ruzafa cumple con la normativa actual de ruidos. Si consultamos el anexo II de la "Ley 7/2002, de 3 de diciembre, de protección contra la contaminación acústica", encontraremos la siguiente tabla:
[](data/table_db_externos.png)
Esta hace referencia al nivel sonoro diurno y nocoturno para cada tipo de uso, en nuestro caso el barrio de Ruzafa lo tomaremos como una zona residencial.

Ahora si nos fijamos en el gráfico en la evolución de dichos niveles podemos observar con facilidad que para ningún día de la semana están por debajo del nivel legal.

Con esto podemos afirmar que en el barrio de Ruzafa existe una gran cantidad de contaminación acústica y que se debería tratar de tomar medidas para reducir estos niveles de ruido a los que nos indica la ley.



Vamos a ver como evoluciona a lo largo de los meses. Se utilizará solo el nivel sonoro continuo equivalente
```{r}
meses = c("enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiempre","octubre","noviembre","diciembre")
grafico = total %>%
  #Se añade la columna con el día de la semana
  mutate(mes_num = month(Dia_medicion)) %>%
  #Se utiliza solo el nivel sonoro equivalente
  filter(tipo_medida == "Nivel_sonoro_continuo_equivalente") %>%
  #Se elimina la columna dia medición
  select(-Dia_medicion) %>%
  #Se agrupa por dia y el tipo de medida para hacer una columna de valor una media
  group_by(mes_num, tipo_medida) %>%
  mutate(valor = mean(valor)) %>%
  #Se eliminan los repetidos
  unique() %>%
  #Se hace una columna con el mes
  mutate(mes = meses[mes_num]) %>%
  mutate(mes = factor(mes,ordered = T, levels = meses)) %>%
  #Se hace el gráfico en función del tipo del mes
  ggplot(aes(x = mes, y = valor, fill = mes)) + 
  geom_bar(stat="identity") + 
  theme(legend.position="none",axis.text.x = element_text(angle = 45,hjust = 1, vjust = 1)) + 
  coord_cartesian(ylim = c(55,65)) +
  labs(title = "Distribución del sonido en función del mes", x = "Mes", y = "Nivel sonoro equivalente", caption = "Fijarse en el eje y")
ggplotly(grafico, height = 350, width=600)
```
En este gráfio hemos representado el nivel sonoro continuo equivalente por meses en el barrio de Ruzafa.

Al ser una representación por meses lo primero que nos vino a la cabeza al ver el gráfico fue la hipostesis de que en los meses que más elevado era el nivel sonoro debian corresponderse con los meses que tuvieran festividades destacables en el barrio de Ruzafa. Así pues nos pusimos a buscar las festividades del barrio de ruzafa (solo las más reseñables) ya que necesitabamos festividades con el suficiente impacto y duración como para alterar la estadistica de sonido de un mes completo. De este modo encontramos las siguientes festividades que podrian ser útiles para la corroboración de nuestra hipotesis:

  + Vacaciones de navidad del 23/12 al 07/01
  
  + Vacaciones de fallas del 16/03 al 19/03
  
  + Vacaciones de pascua del 14/04 al 25/04
  
Después de no encontrar muchas fiestas lo suficientemente grandes como para alterar el nivel de decibelios de un mes completo decidimos analizar las que teniamos y dar nuestras conclusiones al respecto.

Si nos damos cuenta nuestra hipostesis de que en las festividades más grandes debia haber un nivel de ruido mayor, realmente solo se cumple en e mes de marzo con la festividad de las fallas en éste. Pero obviamente un solo caso no indica nada y más conociendo la festividad de las fallas. festividad donde la actividad principal son el lanzamiento de petardos, tracas, castillos, mascletaes y fuegos artificiales entre otros. Todos estos modifican de manera considerable el nivel sonoro del barrio en el mes de marzo.

Es más en el mes siguiente, abril, podemos ver un descenso muy considerble en los niveles de ruido convirtiendose en el més mas silencioso del año en el barrio de Ruzafa. Esto no concuerda tampoco con nuestra hipotesis ya que en el mes de abril nos encontramos con otra festividad lo suficientemente grande como para pensar que elevaria los niveles sonoros por encima de la media.

Así pues concluimos que nuestr hipotesis inicial era falsa, y que no son suficientes estas festividades como para elevar los niveles sonoros por encima de la media en el barrio.

Pero había que investrigar entonces los dos casos raros que nos quedaban en el gráfico, el mes de abril, como podia ser el más silencioso? Y por otra parte septiembre, como podia tener unos niveles de ruido tan elevados distanciandose solo 1db por debajo del mes de las Fallas?

Nos pusimos a investigar y concluimos que:

Es popsible que los niveles sonoros sean menores en el mes de abril debido a que después de un mes como marzo, con las fallas, es posible que la gente prefiera un entorno más tranquilo y por ello tranten de hacer menos ruido. Por otra parte también es posible que en el mes de abril debido a que la festividad de semana santa es una festividad en la que la gentre prefiere irse fuera a la comunidad autonoma de andalucia porque allí la fiesta se v ive mucho más es posible que el barrio de Ruzafa este menos transitado durante este mes y por eso encontramos que es el mes mas silencioso.

El otro caso que se sale de la media es septiembre, aqui hemos encontrado dos posibilidades:

Como el gráfico hace referencia al año 2021 en el mes de septiembre de ese año se celebraron las fiestas de las fallas que no se pudieron celebrar en el mes de marzo anterior. Pero esto no dejaría sin una explicación razonable para porque el mes de marzo fue tan tuidoso si no hubo ceebración de fallas.

La otra explicación que encontramos al alto nivel sonoro del mes de septiembre es que en éste mes empiezan las clases en todos los niveles educativos y como ruzafa es un barrio frecuentado por gente joven, estudiantes en su gran mayoria y tiene muchas zonas de ocio es posible que con la vuelta a las clases haya una mayor actividad en las calles y por eso los sonómetros registren valores tan elevados. 

Ahora vamos a continuar viendo la evolución del ruido por dias segun las calles
```{r}
coordx = c("Cadiz_3" = 3, "Cadiz_16" = 3, "Carles_Cervera_34" = 3.2, "Carles_Cervera_Chaflan_Reina_Dona_Maria" = 3,"Cuba_3" = 0.86, "Doctor_Serrano_21" = 3.1, "General_Prim_Chaflan_Donoso_Cortes" = 6, "Puerto_Rico_21" = 1.5, "Salvador_Abril_Chaflan_Maestro_Jose_Serrano" = 6, "Sueca_2" = 1.95, "Sueca_32" = 1.95, "Sueca_61" = 1.95, "Sueca_Esq_Denia" = 1.95, "Vivons_Chaflan_Cadiz" = 3)
coordy = c("Cadiz_3" = 4.25, "Cadiz_16" = 4.1, "Carles_Cervera_34" = 2, "Carles_Cervera_Chaflan_Reina_Dona_Maria" = 1.85,"Cuba_3" = 4.25, "Doctor_Serrano_21" = 3.35, "General_Prim_Chaflan_Donoso_Cortes" = 2.2, "Puerto_Rico_21" = 2.93, "Salvador_Abril_Chaflan_Maestro_Jose_Serrano" = 3.1, "Sueca_2" = 4.5, "Sueca_32" = 2.9, "Sueca_61" = 1.6, "Sueca_Esq_Denia" = 4, "Vivons_Chaflan_Cadiz" = 1)

ruzafa = readPNG("./data/ruzafa.png")

df %>% 
  #Se añade la columna con el día de la semana
  mutate(mes_num = month(Dia_medicion)) %>%
  #Se utiliza solo el nivel sonoro equivalente
  filter(tipo_medida == "Nivel_sonoro_continuo_equivalente") %>%
  #Se elimina la columna dia medición
  select(-Dia_medicion) %>%
  #Se agrupa por dia y el tipo de medida para hacer una columna de valor una media
  group_by(mes_num, tipo_medida, Nombre_calle) %>%
  mutate(valor = mean(valor)) %>%
  #Se eliminan los repetidos
  unique() %>%
  #Se hace una columna con el mes
  mutate(mes = meses[mes_num]) %>%
  mutate(mes = factor(mes,ordered = T, levels = meses)) %>%
  #Se utiliza solo el nivel sonoro equivalente
  filter(tipo_medida == "Nivel_sonoro_continuo_equivalente") %>%
  #Se hace el gráfico
  ggplot(aes(x = coordx[Nombre_calle], y = coordy[Nombre_calle])) +
  background_image(ruzafa) +
  geom_point(alpha=0.5, aes(col = valor, size = valor)) +
  xlim(c(0,6)) + 
  ylim(c(0,4.5)) +
  scale_size_continuous(range = c(5, 20)) +
  scale_color_continuous_sequential(palette = "Reds", l1 = 20, c2 = 70, p1 = 1) +
  theme(legend.position = "None",axis.text.x = element_blank(),axis.text.y = element_blank()) +
  transition_manual(frames = mes) +
  labs(title = "Distribución de sonidos en función del mes y el lugar", subtitle = "{current_frame}", x = element_blank(), y = element_blank())
```


